name: EAS Android Preview

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "mobile/**"
      - ".github/workflows/eas-android-preview.yml"

concurrency:
  group: eas-android-preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build (Android / preview)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Check EXPO_TOKEN
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "${EXPO_TOKEN}" ]; then
            echo "❌ Missing EXPO_TOKEN secret"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            package-lock.json
            mobile/package-lock.json

      - name: Setup Expo + EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: 16.28.0
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install deps (root, if needed)
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "No root package-lock.json — skipping root npm ci"
          fi

      - name: Install deps (mobile)
        working-directory: mobile
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          npx expo --version
          npx expo config --json > /tmp/expo-config.json

      - name: Create mobile/credentials.json (for credentialsSource=local)
        working-directory: mobile
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "❌ Missing ANDROID_KEYSTORE_BASE64 secret (local credentials mode needs it)."
            exit 1
          fi

          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const b64 = process.env.ANDROID_KEYSTORE_BASE64;
          const storePassword = process.env.ANDROID_KEYSTORE_PASSWORD || '';
          const keyAlias = process.env.ANDROID_KEY_ALIAS || '';
          const keyPassword = process.env.ANDROID_KEY_PASSWORD || storePassword;

          if (!b64 || !storePassword || !keyAlias) {
            console.error("Missing one of: ANDROID_KEYSTORE_BASE64 / ANDROID_KEYSTORE_PASSWORD / ANDROID_KEY_ALIAS");
            process.exit(1);
          }

          fs.mkdirSync('credentials', { recursive: true });
          const jksPath = path.join('credentials', 'android-upload.jks');
          fs.writeFileSync(jksPath, Buffer.from(b64, 'base64'));

          const credentials = {
            android: {
              keystore: {
                keystorePath: "./credentials/android-upload.jks",
                keystorePassword: storePassword,
                keyAlias,
                keyPassword
              }
            }
          };

          fs.writeFileSync('credentials.json', JSON.stringify(credentials, null, 2));
          console.log("✅ Wrote mobile/credentials.json and mobile/credentials/android-upload.jks");
          NODE

      - name: Trigger EAS Build (Android preview)
        run: |
          set -euo pipefail
          mkdir -p dist
          cd mobile

          eas build \
            --platform android \
            --profile preview \
            --non-interactive \
            --json \
            --no-wait > ../dist/eas-build.json

          cd ..
          node - <<'NODE'
          const fs = require('fs');
          const txt = fs.readFileSync('dist/eas-build.json','utf8').trim();
          if (!txt) { console.error('eas-build.json is empty'); process.exit(1); }
          const j = JSON.parse(txt);
          const b = Array.isArray(j) ? j[0] : j;
          const id = b.id || b.buildId || (b.build && b.build.id);
          if (!id) { console.error('No build id in JSON'); process.exit(1); }
          fs.writeFileSync('dist/build-id.txt', String(id));
          console.log('BUILD_ID=' + id);
          NODE

      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: eas-android-preview-meta
          path: dist/
