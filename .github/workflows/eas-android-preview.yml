name: EAS Android Preview (APK)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "mobile/**"
      - ".github/workflows/eas-android-preview.yml"

permissions:
  contents: read

jobs:
  build_android_apk:
    runs-on: ubuntu-latest
    timeout-minutes: 80
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: mobile/package-lock.json

      - name: Install dependencies (mobile)
        working-directory: mobile
        run: |
          rm -rf node_modules
          npm ci || npm install

      - name: Install EAS CLI (pinned)
        run: |
          npm i -g eas-cli@16.28.0
          eas --version

      - name: Start EAS build (no-wait)
        id: start
        working-directory: mobile
        run: |
          mkdir -p ../dist
          eas build --platform android --profile preview --non-interactive --json --no-wait > ../dist/eas-build.json

          BUILD_ID=$(node -e "const fs=require('fs'); const txt=fs.readFileSync('../dist/eas-build.json','utf8').trim(); const j=JSON.parse(txt); const b=Array.isArray(j)?j[0]:j; const id=b.id||b.buildId||(b.build&&b.build.id); if(!id) process.exit(2); console.log(id);")
          echo "BUILD_ID=$BUILD_ID"
          echo "build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"
          echo "$BUILD_ID" > ../dist/build-id.txt

      - name: Wait for build + download artifact
        id: wait
        run: |
          set -euo pipefail
          BUILD_ID="${{ steps.start.outputs.build_id }}"
          echo "Waiting for EAS build: $BUILD_ID"
          mkdir -p dist

          for i in $(seq 1 180); do
            eas build:view "$BUILD_ID" --json > dist/build-view.json

            STATUS=$(node -e "const b=require('./dist/build-view.json'); console.log(String(b.status||'').toUpperCase());")
            echo "STATUS=$STATUS"

            if [ "$STATUS" = "FINISHED" ]; then
              URL=$(node -e "const b=require('./dist/build-view.json'); const a=b.artifacts||{}; console.log(a.buildUrl||a.applicationArchiveUrl||a.apkUrl||a.url||'');")
              if [ -n "$URL" ]; then
                echo "$URL" > dist/artifact-url.txt
                break
              fi
            fi

            if [ "$STATUS" = "ERRORED" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "Build failed. See dist/build-view.json"
              exit 1
            fi

            sleep 20
          done

          test -f dist/artifact-url.txt
          URL="$(cat dist/artifact-url.txt)"
          echo "Artifact URL: $URL"
          curl -L "$URL" -o dist/app.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-preview-apk
          path: |
            dist/app.apk
            dist/build-view.json
            dist/artifact-url.txt
            dist/../dist/eas-build.json
