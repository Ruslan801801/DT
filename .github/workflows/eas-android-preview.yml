name: EAS Android Preview

on:
  workflow_dispatch:
  push:
    branches: [ "main", "develop" ]
    paths:
      - "mobile/**"
      - "eas.json"
      - ".github/workflows/eas-android-preview.yml"

concurrency:
  group: eas-android-preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_android_preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    steps:
      - name: Check EXPO_TOKEN
        run: |
          if [ -z "${EXPO_TOKEN}" ]; then
            echo "❌ Missing EXPO_TOKEN secret (Settings → Secrets and variables → Actions)."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cleanup node_modules (in case they are committed or broken)
        run: |
          rm -rf node_modules mobile/node_modules || true

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: 16.28.0
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies (smart)
        shell: bash
        run: |
          set -euo pipefail

          # 1) Install at repo root if lockfile exists (monorepo/workspaces friendly)
          if [ -f yarn.lock ]; then
            corepack enable || true
            yarn --version
            yarn install --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci
          elif [ -f pnpm-lock.yaml ]; then
            corepack enable || true
            pnpm --version
            pnpm install --frozen-lockfile
          else
            echo "No lockfile at root -> skipping root install"
          fi

          # 2) Install in mobile (if it is standalone OR has its own lockfile)
          if [ -f mobile/package.json ]; then
            if [ -f mobile/yarn.lock ]; then
              corepack enable || true
              (cd mobile && yarn install --frozen-lockfile)
            elif [ -f mobile/package-lock.json ]; then
              (cd mobile && npm ci)
            else
              # fallback only if mobile/node_modules is still missing
              if [ ! -d mobile/node_modules ]; then
                (cd mobile && npm install)
              fi
            fi
          else
            echo "❌ mobile/package.json not found"
            exit 1
          fi

      - name: Validate Expo config (debug)
        run: |
          cd mobile
          # this must work now; otherwise EAS will fallback and часто ломается дальше
          npx --yes expo config --json > /dev/null

      - name: Trigger EAS build (android preview)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          cd mobile

          eas build \
            --platform android \
            --profile preview \
            --non-interactive \
            --json \
            --no-wait > ../dist/eas-build.json

          cd ..

          node - <<'NODE'
          const fs = require('fs');
          const txt = fs.readFileSync('dist/eas-build.json','utf8').trim();
          if (!txt) { console.error('eas-build.json is empty'); process.exit(1); }
          const j = JSON.parse(txt);
          const b = Array.isArray(j) ? j[0] : j;
          const id = b.id || b.buildId || (b.build && b.build.id);
          if (!id) { console.error('No build id in JSON'); process.exit(1); }
          fs.writeFileSync('dist/build-id.txt', String(id));
          console.log('BUILD_ID=' + id);
          NODE

      - name: Upload metadata
        uses: actions/upload-artifact@v4
        with:
          name: eas-android-preview
          path: |
            dist/eas-build.json
            dist/build-id.txt
