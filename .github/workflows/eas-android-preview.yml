name: EAS Android Preview

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "mobile/**"
      - "shared/**"
      - "native/**"
      - ".github/workflows/eas-android-preview.yml"

permissions:
  contents: read

jobs:
  build-android-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Check EXPO_TOKEN
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "❌ EXPO_TOKEN secret is missing. Add it in repo Settings -> Secrets and variables -> Actions."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      # Node 20 — наиболее совместимый вариант для RN/Expo сейчас
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: 16.28.0
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install mobile deps
        working-directory: mobile
        run: npm install --no-audit --no-fund

      - name: Trigger EAS build (Android / preview)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p dist

          cd mobile
          eas build \
            --platform android \
            --profile preview \
            --non-interactive \
            --json \
            --no-wait > ../dist/eas-build.json
          cd ..

          node - <<'NODE'
          const fs = require('fs');

          const txt = fs.readFileSync('dist/eas-build.json','utf8').trim();
          if (!txt) { console.error('eas-build.json is empty'); process.exit(1); }

          const j = JSON.parse(txt);
          const b = Array.isArray(j) ? j[0] : j;

          const id =
            b.id ||
            b.buildId ||
            (b.build && (b.build.id || b.build.buildId));

          const url =
            b.buildDetailsPageUrl ||
            b.detailsPageUrl ||
            b.buildUrl ||
            (b.build && (b.build.detailsPageUrl || b.build.buildDetailsPageUrl));

          if (!id) { console.error('No build id in JSON'); process.exit(1); }

          fs.writeFileSync('dist/build-id.txt', String(id));
          console.log('BUILD_ID=' + id);
          if (url) console.log('BUILD_URL=' + url);
          NODE

      - name: Upload build metadata
        uses: actions/upload-artifact@v4
        with:
          name: eas-android-preview
          path: dist/*
          if-no-files-found: error
