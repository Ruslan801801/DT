name: Android APK (EAS)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "EAS build profile"
        required: true
        default: "preview"

jobs:
  build-android-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps (mobile)
        working-directory: mobile
        run: |
          if [ -f package-lock.json ]; then
            npm ci --include=dev
          else
            npm install --include=dev --no-audit --no-fund
          fi

      - name: Install EAS CLI
        run: npm i -g eas-cli

      - name: Trigger & wait EAS build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          PROFILE="${{ github.event.inputs.profile }}"
          mkdir -p dist
          cd mobile
          eas build --platform android --profile "$PROFILE" --non-interactive --json > ../dist/eas-build.json
          cd ..

      - name: Extract build id
        run: node scripts/extract-eas-build-id.js

      - name: Download APK
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          BUILD_ID="$(cat dist/build-id.txt)"
          echo "Downloading build id: $BUILD_ID"
          eas build:download --id "$BUILD_ID" --platform android --non-interactive --path dist/DT.apk

      - name: Upload artifact (APK + build json)
        uses: actions/upload-artifact@v4
        with:
          name: DT-android-apk
          path: |
            dist/DT.apk
            dist/eas-build.json


