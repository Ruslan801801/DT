name: Android APK (EAS)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: EAS build profile
        required: true
        default: preview

jobs:
  android-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install mobile deps
        working-directory: mobile
        run: |
          if [ -f package-lock.json ]; then
            npm ci --include=dev
          else
            npm install --include=dev --no-audit --no-fund
          fi

      - name: Install EAS CLI
        run: npm i -g eas-cli

      - name: Prepare Android signing (local credentials.json)
        working-directory: mobile
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -e
          printf "%s" "$ANDROID_KEYSTORE_BASE64" | base64 -d > release.keystore
          cat > credentials.json <<JSON
          {
            "android": {
              "keystore": {
                "keystorePath": "release.keystore",
                "keystorePassword": "${ANDROID_KEYSTORE_PASSWORD}",
                "keyAlias": "${ANDROID_KEY_ALIAS}",
                "keyPassword": "${ANDROID_KEY_PASSWORD}"
              }
            }
          }
JSON

      - name: Build APK on EAS (wait + json)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          mkdir -p dist
          cd mobile

          PROFILE="${{ inputs.profile }}"

          set +e
          eas build --platform android --profile "$PROFILE" --non-interactive --wait --json > ../dist/eas-build.json
          EAS_CODE=$?
          set -e

          echo "EAS_EXIT_CODE=$EAS_CODE" >> $GITHUB_ENV
          echo "----- eas-build.json -----"
          cat ../dist/eas-build.json || true

          # Если build упал — всё равно оставим json артефактом, но job должен упасть
          if [ "$EAS_CODE" -ne 0 ]; then
            exit 1
          fi

      - name: Download APK from buildUrl
        run: |
          set -e
          URL="$(node - <<'NODE'
          const fs = require('fs');
          const p = 'dist/eas-build.json';
          const raw = fs.readFileSync(p,'utf8');
          const j = JSON.parse(raw);
          const b = Array.isArray(j) ? j[0] : j;
          const url = (b && b.artifacts && (b.artifacts.buildUrl || b.artifacts.applicationArchiveUrl)) || '';
          process.stdout.write(url);
NODE
          )"
          if [ -z "$URL" ]; then
            echo "No buildUrl in dist/eas-build.json"
            exit 2
          fi
          echo "Downloading: $URL"
          curl -L "$URL" -o dist/app.apk
          ls -lh dist/app.apk

      - name: Upload artifacts (APK + JSON)
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            dist/app.apk
            dist/eas-build.json
