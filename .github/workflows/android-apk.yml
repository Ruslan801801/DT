name: Android APK (EAS)

on:
  workflow_dispatch:

jobs:
  build-android-apk:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install mobile deps
        working-directory: mobile
        run: |
          if [ -f package-lock.json ]; then
            npm ci --include=dev
          else
            npm install --include=dev --no-audit --no-fund
          fi

      - name: Prepare dist
        run: mkdir -p dist

      - name: Restore local keystore + credentials.json
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > mobile/release.keystore
          cat > mobile/credentials.json <<EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "release.keystore",
                "keystorePassword": "$ANDROID_KEYSTORE_PASSWORD",
                "keyAlias": "$ANDROID_KEY_ALIAS",
                "keyPassword": "$ANDROID_KEY_PASSWORD"
              }
            }
          }
          EOF

      - name: Trigger EAS build (APK)
        shell: bash
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          cd mobile
          npx --yes eas-cli@latest build --platform android --profile preview --non-interactive --json > ../dist/eas-start.json
          cd ..
          node - <<'NODE'
          const fs = require('fs');
          const j = JSON.parse(fs.readFileSync('dist/eas-start.json','utf8'));
          const b = Array.isArray(j) ? j[0] : j;
          const id = b.id || b.buildId || (b.build && b.build.id);
          if (!id) { console.error('No build id'); process.exit(1); }
          fs.writeFileSync('dist/build-id.txt', String(id));
          console.log('BUILD_ID=' + id);
          NODE

      - name: Wait build + download APK
        shell: bash
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          BUILD_ID="$(cat dist/build-id.txt)"

          for i in $(seq 1 120); do
            npx --yes eas-cli@latest build:view --id "$BUILD_ID" --json > dist/eas-view.json
            STATUS="$(node -p "require('./dist/eas-view.json').status")"
            echo "status=$STATUS (try $i/120)"
            if [ "$STATUS" = "finished" ]; then break; fi
            if [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
              npx --yes eas-cli@latest build:logs --id "$BUILD_ID" > dist/eas-logs.txt || true
              exit 1
            fi
            sleep 30
          done

          npx --yes eas-cli@latest build:download --id "$BUILD_ID" --platform android --output dist/app.apk

      - name: Upload artifact (APK + logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            dist/app.apk
            dist/eas-start.json
            dist/eas-view.json
            dist/eas-logs.txt
            dist/build-id.txt
