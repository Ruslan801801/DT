name: Android APK (EAS)

on:
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install mobile deps
        shell: bash
        run: |
          set -euo pipefail
          cd mobile
          if [ -f package-lock.json ]; then
            npm ci --include=dev --no-audit --no-fund
          else
            npm install --include=dev --no-audit --no-fund
          fi

      - name: Prepare Android credentials (local)
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          cd mobile

          # keystore from base64
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > release.keystore

          # credentials.json expected by EAS when credentialsSource=local
          cat > credentials.json <<EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "release.keystore",
                "keystorePassword": "$ANDROID_KEYSTORE_PASSWORD",
                "keyAlias": "$ANDROID_KEY_ALIAS",
                "keyPassword": "$ANDROID_KEY_PASSWORD"
              }
            }
          }
          EOF

      - name: Trigger EAS build (preview APK) and wait
        shell: bash
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p dist
          cd mobile

          # ВАЖНО: --wait чтобы дождаться результата
          npx --yes eas-cli@latest build \
            --platform android \
            --profile preview \
            --non-interactive \
            --wait \
            --json > ../dist/eas-build.json

      - name: Fetch build details (JSON)
        shell: bash
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require('fs');
          const j = JSON.parse(fs.readFileSync('dist/eas-build.json','utf8'));
          const id = j.id || j.buildId || (Array.isArray(j) ? j[0]?.id : undefined);
          if (!id) { console.error('No build id in dist/eas-build.json'); process.exit(1); }
          fs.writeFileSync('dist/build-id.txt', id + '\n');
          console.log('BUILD_ID=', id);
          NODE

          BUILD_ID="$(cat dist/build-id.txt)"
          cd mobile
          npx --yes eas-cli@latest build:view --build-id "$BUILD_ID" --json > ../dist/eas-build-view.json

      - name: Download APK
        shell: bash
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require('fs');
          const view = JSON.parse(fs.readFileSync('dist/eas-build-view.json','utf8'));
          const a = view.artifacts || {};
          const url = a.buildUrl || a.applicationArchiveUrl || a.apkUrl || a.downloadUrl;
          if (!url) {
            console.error('No APK url found in artifacts. Full artifacts:', JSON.stringify(a,null,2));
            process.exit(1);
          }
          fs.writeFileSync('dist/apk-url.txt', url + '\n');
          console.log('APK_URL=', url);
          NODE

          URL="$(cat dist/apk-url.txt)"
          curl -L "$URL" -o dist/DT-preview.apk
          ls -lah dist

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DT-preview-apk
          path: |
            dist/DT-preview.apk
            dist/eas-build.json
            dist/eas-build-view.json
            dist/build-id.txt
            dist/apk-url.txt
