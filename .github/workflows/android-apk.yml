name: Android APK (EAS)

on:
  workflow_dispatch:
  # хочешь автоматом на теги:
  # push:
  #   tags: ["v*"]

jobs:
  build-android-apk:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache НЕ включаем, пока нет стабильного lockfile на root и пока ловим битые deps

      - name: Install deps (root workspaces)
        shell: bash
        run: |
          set -euo pipefail
          npm cache clean --force || true
          npm install --include=dev --no-audit --no-fund --legacy-peer-deps

      - name: Restore local Android credentials into mobile/
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          test -n "${ANDROID_KEYSTORE_BASE64}"

          cd mobile
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > release.keystore

          cat > credentials.json <<EOF
          {
            "android": {
              "keystore": {
                "keystorePath": "release.keystore",
                "keystorePassword": "${ANDROID_KEYSTORE_PASSWORD}",
                "keyAlias": "${ANDROID_KEY_ALIAS}",
                "keyPassword": "${ANDROID_KEY_PASSWORD}"
              }
            }
          }
          EOF

          chmod 600 release.keystore credentials.json

      - name: EAS build (Android preview APK)
        shell: bash
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p dist
          cd mobile

          # Пин версии помогает избежать сюрпризов
          npx --yes eas-cli@16.28.0 build \
            --platform android \
            --profile preview \
            --non-interactive \
            --json > ../dist/eas-build.json

          cd ..

          node - <<'NODE'
          const fs = require('fs');
          const txt = fs.readFileSync('dist/eas-build.json','utf8').trim();
          if (!txt) { console.error('eas-build.json is empty'); process.exit(1); }
          const j = JSON.parse(txt);
          const b = Array.isArray(j) ? j[0] : j;
          const id = b.id || b.buildId || (b.build && b.build.id);
          if (!id) { console.error('No build id in JSON'); process.exit(1); }
          fs.writeFileSync('dist/build-id.txt', String(id));
          console.log('BUILD_ID=' + id);
          NODE

      - name: Download APK from EAS
        shell: bash
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          BUILD_ID="$(cat dist/build-id.txt)"
          # Скачиваем прямо через EAS CLI (стабильнее чем выковыривать URL)
          npx --yes eas-cli@16.28.0 build:download \
            --platform android \
            --id "$BUILD_ID" \
            --output dist/DT-preview.apk \
            --non-interactive

          ls -lah dist/DT-preview.apk
          # простая защита от "пустого" файла
          test "$(stat -c%s dist/DT-preview.apk)" -gt 1000000

      - name: Upload artifact (APK)
        uses: actions/upload-artifact@v4
        with:
          name: DT-android-apk
          path: |
            dist/DT-preview.apk
            dist/eas-build.json
            dist/build-id.txt
