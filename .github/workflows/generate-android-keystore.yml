name: Generate Android Keystore (one-time)

on:
  workflow_dispatch:

jobs:
  gen:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Generate keystore
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts

          ALIAS="upload"
          STOREPASS="$(openssl rand -base64 24 | tr -d '\n' | tr '/+' 'Aa' | cut -c1-24)"
          KEYPASS="$STOREPASS"

          PKG="$(node -e "const j=require('./mobile/app.json'); console.log((j.expo && j.expo.android && j.expo.android.package) ? j.expo.android.package : 'ru.deeptea.dt')")"

          keytool -genkeypair -v \
            -storetype JKS \
            -keystore artifacts/release.keystore \
            -alias "$ALIAS" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass "$STOREPASS" -keypass "$KEYPASS" \
            -dname "CN=$PKG, OU=Mobile, O=DeepTea, L=Oslo, S=Oslo, C=NO"

          base64 -w 0 artifacts/release.keystore > artifacts/release.keystore.b64

          cat > artifacts/keystore-info.txt <<EOF
          ANDROID_KEYSTORE_PASSWORD=$STOREPASS
          ANDROID_KEY_PASSWORD=$KEYPASS
          ANDROID_KEY_ALIAS=$ALIAS
          ANDROID_PACKAGE=$PKG
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-keystore
          path: artifacts/*
