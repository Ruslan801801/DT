*** a/server/src/main.ts
--- b/server/src/main.ts
@@
  import { NestFactory } from '@nestjs/core';
  import { AppModule } from './app.module';
  import helmet from 'helmet';
  import * as express from 'express';

  async function bootstrap() {
    const app = await NestFactory.create(AppModule);
+   // доверяем заголовкам прокси (X-Forwarded-For / Proto) для корректного req.ip
+   app.set('trust proxy', 1);
    // Безопасные заголовки
    app.use(helmet());
    // Лимиты на размер тела запроса
    app.use(express.json({ limit: '10mb' }));
    app.use(express.urlencoded({ extended: true, limit: '10mb' }));

    // Простой readiness endpoint
    app.getHttpAdapter().getInstance().get('/ready', (_req, res) => res.status(200).send('OK'));
    await app.listen(process.env.PORT || 3000);
  }
  bootstrap();

*** a/infra/nginx/nginx.conf
--- b/infra/nginx/nginx.conf
@@
  http {
    upstream api {
      server api:3000;
      keepalive 32;
    }
-  limit_req_zone $binary_remote_addr zone=api_zone:10m rate=10r/s;
+  limit_req_zone $binary_remote_addr zone=api_zone:10m rate=10r/s;
+  limit_req_status 429;
    server {
      listen 80;
      location /api/ {
        limit_req zone=api_zone burst=20 nodelay;
        proxy_pass http://api;
        proxy_http_version 1.1;
-      proxy_set_header Connection "";
+      # Стандартные заголовки проксирования
+      proxy_set_header Host              $host;
+      proxy_set_header X-Real-IP         $remote_addr;
+      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
+      proxy_set_header X-Forwarded-Proto $scheme;
+
+      proxy_read_timeout   60s;
+      proxy_connect_timeout 5s;
      }
      location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
      }
    }
  }

*** /dev/null
--- b/docs/db/manual-indexes.sql
@@
+-- Эти индексы рекомендуется применять ВНЕ транзакции (например, вручную в psql),
+-- потому что CREATE INDEX CONCURRENTLY нельзя выполнять в транзакции (а Prisma миграции обычно транзакционные).
+
+CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_transactions_status_created 
+  ON transactions(status, created_at) WHERE status = 'pending';
+
+CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_vouchers_state_expires 
+  ON vouchers(state, expires_at) WHERE state IN ('issued', 'handed_over');
+
*** /dev/null
--- b/mobile/src/config.ts
@@
+export const CONFIG = {
+  API_BASE_URL: process.env.EXPO_PUBLIC_API_URL ?? 'http://localhost:3000',
+  REQUEST_TIMEOUT_MS: 10000,
+};
+
*** a/mobile/src/services/api.ts
--- b/mobile/src/services/api.ts
@@
-import { CONFIG } from '../config';
-
-const delay = (ms: number) => new Promise(r => setTimeout(r, ms));
-const cryptoRandom = () => Math.random().toString(36).slice(2);
-
-export const api = {
-  async p2pCreate(body: any, retries = 3) {
-    for (let i = 0; i < retries; i++) {
-      try {
-        const res = await fetch(`${CONFIG.API_BASE_URL}/api/p2p/create`, {
-          method: 'POST',
-          headers: {
-            'Content-Type': 'application/json',
-            'Idempotency-Key': `${cryptoRandom()}:${Date.now()}`
-          },
-          body: JSON.stringify(body),
-        });
-        if (!res.ok) throw new Error(`HTTP ${res.status}`);
-        return await res.json();
-      } catch (err) {
-        if (i === retries - 1) throw err;
-        await delay(1000 * Math.pow(2, i)); // 1s, 2s, 4s
-      }
-    }
-  }
-};
+import { CONFIG } from '../config';
+
+const delay = (ms: number) => new Promise(r => setTimeout(r, ms));
+const cryptoRandom = () => Math.random().toString(36).slice(2);
+
+const withTimeout = async <T>(p: Promise<T>, ms: number, ctrl: AbortController) => {
+  const t = setTimeout(() => ctrl.abort('Request timeout'), ms);
+  try { return await p; } finally { clearTimeout(t); }
+};
+
+export const api = {
+  async p2pCreate(body: any, retries = 3) {
+    const key = `${cryptoRandom()}:${Date.now()}`;
+    for (let i = 0; i < retries; i++) {
+      const ctrl = new AbortController();
+      try {
+        const res = await withTimeout(fetch(`${CONFIG.API_BASE_URL}/api/p2p/create`, {
+          method: 'POST',
+          headers: {
+            'Content-Type': 'application/json',
+            'Idempotency-Key': key
+          },
+          body: JSON.stringify(body),
+          signal: ctrl.signal,
+        }), CONFIG.REQUEST_TIMEOUT_MS, ctrl);
+
+        if (!res.ok) throw new Error(`HTTP ${res.status}`);
+        return await res.json();
+      } catch (err) {
+        if (i === retries - 1) throw err;
+        await delay(1000 * Math.pow(2, i)); // 1s, 2s, 4s
+      }
+    }
+  }
+};

*** a/mobile/src/store/appStore.ts
--- b/mobile/src/store/appStore.ts
@@
-const logger =
+const logger =
   (config: any) =>
   (set: any, get: any, api: any) =>
     config((args: any) => {
-      console.log('[store update]', args);
+      if (__DEV__) {
+        // не шумим в проде
+        // eslint-disable-next-line no-console
+        console.log('[store update]', args);
+      }
       set(args);
     }, get, api);

*** a/mobile/README.md
--- b/mobile/README.md
@@
 # DeepTea Mobile (Expo)

 ## Скрипты
 ```bash
 yarn dev:mobile        # expo start (QR / туннель)
 yarn android:dev       # expo run:android (dev client)
 yarn android:apk       # eas build -p android --profile preview
 ```
+
+## Переменные окружения (через Expo)
+В `app.json`/`app.config.ts` прокинь `EXPO_PUBLIC_API_URL`, чтобы менять бекенд без пересборки:
+```json
+{
+  "expo": {
+    "extra": {
+      "EXPO_PUBLIC_API_URL": "https://api.deeptea.ru"
+    }
+  }
+}
+```
+
+## Разрешения BLE
+- **Android 12+**: `BLUETOOTH_SCAN`, `BLUETOOTH_CONNECT`, (при рекламе) `BLUETOOTH_ADVERTISE`.
+- **Android ≤11**: `ACCESS_FINE_LOCATION` (для сканирования BLE).
+- **iOS**: `NSBluetoothAlwaysUsageDescription` в Info.plist.
+
+Проверь, чтобы нативные модули и манифесты/Info.plist включали эти пермишены.
+
*** /dev/null
--- b/docs/PR-4-followup-NOTES.md
@@
+# Follow-up к PR #4
+
+## Что изменено
+- `trust proxy` в `server/src/main.ts` — корректная IP-адресация за Nginx/ingress.
+- Nginx: стандартные `proxy_set_header`, таймауты, `limit_req_status 429`.
+- Mobile: `config.ts` с `EXPO_PUBLIC_API_URL`, таймаут/abort для fetch, глушим логгер в проде.
+- Док: вынесены индексы в `docs/db/manual-indexes.sql` — применять вручную (CONCURRENTLY вне транзакции).
+
+## Что ещё желательно добавить
+- Singleton Redis-провайдера, чтобы не плодить соединения в middleware.
+- Экспорт метрик в формат histogram (или t-digest для p95) вместо накопления массивов.
+- Проверка наличия `curl` в образе API (или альтернативная команда healthcheck).